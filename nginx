server {
	listen 80 default_server;
	listen [::]:80 default_server;

##########################################################################
	server_name -;

	# install this service to use below security features
	# sudo apt install nginx-extras

	# server_tokens off;
	# more_set_headers "Server: secure";

	location / {
		resolver              1.1.1.1 ipv6=off;
		client_max_body_size 30m;
		proxy_read_timeout 700s;

		# root path to load content
		root /var/www/html;
		# Add index.php to the list if you are using PHP
		index index.html index.htm index.nginx-debian.html;

		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		# proxy_set_header X-Forwarded-Port 443;
		proxy_set_header Connection "";
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_buffer_size          128k;
		proxy_buffers              4 256k;
		proxy_busy_buffers_size    256k;
		proxy_headers_hash_max_size 1024;
		proxy_headers_hash_bucket_size 512;

		# Handle caching
		add_header Cache-Control "no-cache, no-store, must-revalidate";
		add_header Pragma "no-cache";
		add_header Expires 0;
	}

	location /webservice/ {
		resolver 1.1.1.1 ipv6=off;
		client_max_body_size 30m;
		proxy_read_timeout 700s;
		proxy_pass http://127.0.0.1:8000;

		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		# proxy_set_header X-Forwarded-Port 443;
		proxy_set_header Connection "";
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;

		proxy_buffer_size          128k;
		proxy_buffers              4 256k;
		proxy_busy_buffers_size    256k;
		proxy_headers_hash_max_size 1024;
		proxy_headers_hash_bucket_size 512;

		proxy_set_header Authorization $http_authorization;
		proxy_pass_request_headers on;
		proxy_set_header X-Forwarded-Prefix /webservice;

		# Handle caching
		add_header Cache-Control "no-cache, no-store, must-revalidate";
		add_header Pragma "no-cache";
		add_header Expires 0;
	}

	# Added to handle fastapi-doc shield
	location = /openapi.json {
		return 301 /webservice/openapi.json;
	}

	# Added to handle grafana reverse proxy
	location /grafana {
		resolver              1.1.1.1 ipv6=off;
		proxy_pass http://localhost:3000;
		client_max_body_size 30m;

		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_set_header Authorization $http_authorization;
		proxy_pass_request_headers on;

		################################# Wide-open CORS config for nginx

		if ($request_method = 'OPTIONS') {
			add_header 'Access-Control-Allow-Origin' '*';
			add_header 'Access-Control-Allow-Credentials' 'true';
			add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
			add_header 'Access-Control-Allow-Headers' 'Authorization, Access-Control-Allow-Origin, Access-Control-Allow-Methods, X-Authorization, X-Compatibility-Mode, Content-Type, Accept,X-Auth,';
			# add_header 'Access-Control-Request-Headers' 'Authorization, Access-Control-Allow-Origin, Access-Control-Allow-Methods, X-Authorization, X-Compatibility-Mode, Content-Type, Accept,X-Auth,';
			add_header 'Access-Control-Max-Age' 1728000;
			add_header 'Content-Type' 'text/plain charset=UTF-8';
			add_header 'Content-Length' 0;
			return 204;
		}

		if ($request_method = 'POST') {
			add_header 'Access-Control-Allow-Origin' '*';
			add_header 'Access-Control-Allow-Credentials' 'true';
			add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
			add_header 'Access-Control-Allow-Headers' 'Authorization, Access-Control-Allow-Origin, Access-Control-Allow-Methods, X-Authorization, X-Compatibility-Mode, Content-Type, Accept,X-Auth,';
			# add_header 'Access-Control-Request-Headers' 'Authorization, Access-Control-Allow-Origin, Access-Control-Allow-Methods, X-Authorization, X-Compatibility-Mode, Content-Type, Accept,X-Auth,';
		}

		if ($request_method = 'GET') {
			add_header 'Access-Control-Allow-Origin' '*';
			add_header 'Access-Control-Allow-Credentials' 'true';
			add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
			add_header 'Access-Control-Allow-Headers' 'Authorization, Access-Control-Allow-Origin, Access-Control-Allow-Methods, X-Authorization, X-Compatibility-Mode, Content-Type, Accept,X-Auth,';
			# add_header 'Access-Control-Request-Headers' 'Authorization, Access-Control-Allow-Origin, Access-Control-Allow-Methods, X-Authorization, X-Compatibility-Mode, Content-Type, Accept,X-Auth,';
		}
	}
}